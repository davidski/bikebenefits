---
title: "Bike Benefits"
author: "David F. Severski"
date: "July 9, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Background and Motivation

While in the factory store of our local bean-to-bar chcolatier, Theo's 
Chocolate, the spouse pointed out a sign that bicyclists could purchase a sticker 
for their helmet which would give them 50% off one of Theo's standard bars 
each time they came in. I've long wanted a discount program for local folks 
coming in so I jumped on this chance. Looking at the sticker, it turned out not 
to be something specific to Theo's but a larger program run by (Bicycle 
Benefits)[http://www.bicyclebenefits.org/].

An initial glance at the map showed a large number of participating business 
nearby as well as a long list of cities where member business could be 
found. The map is a standard Leaflet module with the data available via a 
simple GET request or two. This had me curious to see more about it....

# Data Acquisiton and Prepping

```{r}
library(jsonlite)
library(purrr)
library(httr)
library(dplyr)

# fetch all cities
cities_url <- 'http://www.bicyclebenefits.org/search/cities'
#cities <- fromJSON(content(GET(cities_url), as = "text"), flatten = TRUE)
#save(cities, file = "data/bikebenefits_cities.Rdata")
load("data/bikebenefits_Cities.Rdata")

# fetch the details for a given city
get_biz <- function(city_id, base_url = 'http://www.bicyclebenefits.org/search/members?city_id=')  {
  search_url <- paste0(base_url, city_id)
  dat <- fromJSON(content(GET(search_url), as = "text"), flatten = TRUE)
  dat$members$city_id <- city_id
  dat$city$city_id <- city_id
  return(dat)
}

#dat <- map(cities$id, get_biz)
#save(dat, file = "data/bikebenefits.Rdata")
load("data/bikebenefits.Rdata")

# coerce member business into a dataframe and peel off categories into 
# a more normalized table
members <- map(dat, "members") %>% compact %>% bind_rows() %>% 
  filter(!is.na(id))
categories <- members %>% distinct(category.id, category.name, category.logo)
categories[categories$category.logo == "","category.logo"] <- NA
members <- members %>% select(-c(category.name, category.logo))

# coerce the states into a dataframe
states <- map(dat, "city")
states <- do.call(rbind, states) %>% as_data_frame
states$state_name <- map_chr(states$state, "name")
states <- select(states, -state) %>% simplify_all %>% bind_rows
```

# Exploration

## Geography
```{r exploration}
members %>% count(city_id, sort = TRUE) %>% 
  left_join(cities, by = c("city_id" = "id")) %>% 
  select(city_name = name, state.name, n)
```

Lots of activity in Charlotte. How does this look at a 
state level?

```{r}
members %>% count(city_id, sort = TRUE) %>% 
  left_join(cities, by = c("city_id" = "id")) %>% 
  select(city_name = name, state.name, n) %>% 
  group_by(state.name) %>% tally(n, sort = TRUE)
```

Wow. Wisconsin has a lot going on, while most of Washington's activity 
looks limited to Seattle.

## Business Type

```{r}
members %>% group_by(city_id, category.id) %>% tally
```
